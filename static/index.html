<!doctype html>
<html lang="ja"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>kintone-chatbot-saas</title>
<style>body{font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;margin:24px}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:16px}.card{border:1px solid #ddd;border-radius:12px;padding:16px}
pre{background:#fafafa;border:1px solid #eee;padding:8px;border-radius:8px;overflow:auto}</style></head>
<body><h1>kintone-chatbot-saas</h1>
<div class="grid">
  <div class="card"><h3>1) Tenant</h3><input id="tenantName" placeholder="tenant name"><button onclick="createTenant()">Create</button>
  <div>Tenant Key: <code id="tenantKey">(not set)</code></div></div>

  <div class="card"><h3>2) Config</h3>
    <input id="name" placeholder="config name" value="sample"><br>
    <input id="domain" placeholder="example.cybozu.com"><br>
    <input id="appId" placeholder="app id"><br>
    <input id="token" placeholder="kintone API token"><br>
    <input id="fields" placeholder="target_fields (comma separated, optional)"><br>
    <button onclick="createConfig()">Create</button> id: <code id="configId"></code>
  </div>

  <div class="card"><h3>3) フィールド取得・選択</h3>
    <input id="configIdForFields" placeholder="config id">
    <button onclick="fetchFields()">Fetch</button>
    <div id="fieldsChoices" style="margin:8px 0"></div>
    <button id="saveBtn" style="display:none" onclick="saveSelectedFields()">選択を保存</button>
    <pre id="fieldsOut"></pre>
  </div>

  <div class="card"><h3>4) Chat</h3>
    <input id="configIdForChat" placeholder="config id">
    <input id="query" placeholder="検索語"><button onclick="chat()">Ask</button>
    <pre id="chatOut"></pre>
  </div>
</div>

<script>
const base = location.origin;
function setText(id, v){ document.getElementById(id).textContent = v }
function getVal(id){ return document.getElementById(id).value }

async function createTenant(){
  const name = getVal('tenantName') || 'demo';
  const r = await fetch(base + '/api/tenants',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name})});
  const j = await r.json(); setText('tenantKey', j.api_key || JSON.stringify(j)); localStorage.setItem('tenantKey', j.api_key);
}
function getKey(){ return localStorage.getItem('tenantKey') || document.getElementById('tenantKey').textContent }

let currentConfigId = null;
async function createConfig(){
  const body = {name:getVal('name'), domain:getVal('domain'), app_id:Number(getVal('appId')),
                api_token_plain:getVal('token'), target_fields:(getVal('fields')||'').split(',').map(s=>s.trim()).filter(Boolean)};
  const r = await fetch(base + '/api/configs',{method:'POST',headers:{'Content-Type':'application/json','X-Tenant-Key':getKey()},body:JSON.stringify(body)});
  const j = await r.json(); currentConfigId = j.id; setText('configId', j.id);
  document.getElementById('configIdForFields').value = j.id; document.getElementById('configIdForChat').value = j.id;
}

function renderFieldChoices(fields){
  const wrap = document.getElementById('fieldsChoices'); wrap.innerHTML='';
  fields.forEach(f=>{ const d=document.createElement('div'); d.innerHTML=`<label><input type="checkbox" value="${(f.code||'').replace(/"/g,'&quot;')}"> <b>${f.code}</b> (${f.type||'unknown'}) ${f.label?'- '+f.label:''}</label>`; wrap.appendChild(d); });
  document.getElementById('saveBtn').style.display='inline-block';
}

async function fetchFields(){
  const id = document.getElementById('configIdForFields').value || currentConfigId;
  const r = await fetch(base + '/api/kintone/fields?config_id=' + encodeURIComponent(id), {headers:{'X-Tenant-Key':getKey()}});
  const j = await r.json(); renderFieldChoices(j.fields || []); document.getElementById('fieldsOut').textContent = JSON.stringify(j,null,2);
}
function getSelected(){ return [...document.querySelectorAll('#fieldsChoices input:checked')].map(i=>i.value) }
async function saveSelectedFields(){
  const id = document.getElementById('configIdForFields').value || currentConfigId;
  const r = await fetch(base + '/api/configs/' + id, {method:'PUT', headers:{'Content-Type':'application/json','X-Tenant-Key':getKey()}, body: JSON.stringify({target_fields:getSelected()})});
  const j = await r.json(); alert('saved: '+(j.target_fields||[]).join(', '));
}

async function chat(){
  const id = Number(document.getElementById('configIdForChat').value || currentConfigId);
  const r = await fetch(base + '/api/chat',{method:'POST',headers:{'Content-Type':'application/json','X-Tenant-Key':getKey()}, body: JSON.stringify({query:getVal('query'), config_id:id})});
  const j = await r.json(); document.getElementById('chatOut').textContent = JSON.stringify(j,null,2);
}
const saved = localStorage.getItem('tenantKey'); if(saved){ setText('tenantKey', saved); }
</script>
</body></html>