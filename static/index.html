<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>kintone-chatbot-saas</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;max-width:880px;margin:40px auto;padding:0 16px;}
    input,button,select,textarea{padding:8px;margin:4px 0;font-size:14px;}
    .card{border:1px solid #e5e7eb;border-radius:12px;padding:16px;margin:12px 0;background:#fff;}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    code{background:#f3f4f6;padding:2px 6px;border-radius:6px}
    .muted{color:#6b7280}
    pre{background:#0b1020;color:#e5e7eb;padding:12px;border-radius:8px;overflow:auto}
  </style>
</head>
<body>
  <h1>kintone-chatbot-saas</h1>
  <p class="muted">テナントキーと設定IDを入れて、簡単にAPIを試せます。</p>

  <div class="card">
    <h3>1) テナント作成</h3>
    <div class="row">
      <input id="tenantName" placeholder="tenant name (e.g. demo)" />
      <button onclick="createTenant()">Create</button>
    </div>
    <div>Tenant Key: <code id="tenantKey"></code></div>
  </div>

  <div class="card">
    <h3>2) Config作成</h3>
    <div class="row">
      <input id="name" placeholder="name" style="min-width:220px">
      <input id="domain" placeholder="xxxx.cybozu.com">
      <input id="appId" placeholder="app_id">
      <input id="token" placeholder="kintone api token">
      <input id="fields" placeholder='target_fields (comma sep) e.g. name,detail'>
      <button onclick="createConfig()">Create</button>
    </div>
    <div>Config ID: <code id="configId"></code></div>
  </div>

  <div class="card">
    <h3>3) フィールド自動取得</h3>
    <div class="row">
      <input id="configIdForFields" placeholder="config id">
      <button onclick="fetchFields()">Fetch</button>
    </div>
    <pre id="fieldsOut"></pre>
  </div>

  <div class="card">
    <h3>4) チャット（LIKE検索）</h3>
    <div class="row">
      <input id="query" placeholder="検索語 (先頭フィールドでLIKE)" style="min-width:320px">
      <input id="configIdForChat" placeholder="config id">
      <button onclick="chat()">Ask</button>
    </div>
    <pre id="chatOut"></pre>
  </div>

<script>
const base = location.origin;

async function createTenant(){
  const name = document.getElementById('tenantName').value || 'demo';
  const r = await fetch(base + '/api/tenants', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({name})
  });
  const j = await r.json();
  document.getElementById('tenantKey').textContent = j.api_key || JSON.stringify(j);
  localStorage.setItem('tenantKey', j.api_key);
}

function getKey(){
  return localStorage.getItem('tenantKey') || document.getElementById('tenantKey').textContent;
}

async function createConfig(){
  const name = document.getElementById('name').value;
  const domain = document.getElementById('domain').value;
  const app_id = Number(document.getElementById('appId').value);
  const api_token_plain = document.getElementById('token').value;
  const target_fields = (document.getElementById('fields').value || '').split(',').map(s=>s.trim()).filter(Boolean);
  const r = await fetch(base + '/api/configs', {
    method:'POST', headers:{
      'Content-Type':'application/json',
      'X-Tenant-Key': getKey()
    },
    body: JSON.stringify({name, domain, app_id, api_token_plain, target_fields})
  });
  const j = await r.json();
  document.getElementById('configId').textContent = j.id || JSON.stringify(j);
}

async function fetchFields(){
  const id = document.getElementById('configIdForFields').value;
  const r = await fetch(base + '/api/kintone/fields?config_id=' + encodeURIComponent(id), {
    headers: {'X-Tenant-Key': getKey()}
  });
  const j = await r.json();
  document.getElementById('fieldsOut').textContent = JSON.stringify(j, null, 2);
}

async function chat(){
  const id = Number(document.getElementById('configIdForChat').value);
  const query = document.getElementById('query').value;
  const r = await fetch(base + '/api/chat', {
    method:'POST', headers:{
      'Content-Type':'application/json',
      'X-Tenant-Key': getKey()
    },
    body: JSON.stringify({query, config_id: id})
  });
  const j = await r.json();
  document.getElementById('chatOut').textContent = JSON.stringify(j, null, 2);
}
</script>
</body>
</html>
